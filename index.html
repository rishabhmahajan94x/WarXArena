<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>WarX Arena</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #4f46e5;   /* Indigo */
            --secondary: #818cf8; /* Light Indigo */
            --bg: #f3f4f6;        /* Light Grey Background */
            --card: #ffffff;      /* White Cards */
            --text: #1f2937;      /* Dark Text */
            --green: #10b981;
            --red: #ef4444;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { background: var(--bg); color: var(--text); height: 100vh; width: 100vw; overflow: hidden; }

        /* --- LAYOUT UTILS --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .center { align-items: center; justify-content: center; }
        .w-full { width: 100%; }
        .scroll-y { overflow-y: auto; padding-bottom: 100px; height: 100%; -webkit-overflow-scrolling: touch; }

        /* --- SCREENS --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; background: var(--bg);
        }
        .screen.active { display: flex; }
        
        #screen-splash { z-index: 9999; background: white; }
        #screen-auth { z-index: 500; }
        #screen-app { z-index: 10; }
        #screen-match-details { z-index: 100; background: var(--bg); }

        /* --- AUTH SCREEN --- */
        .auth-box {
            padding: 30px; width: 100%; max-width: 400px;
            display: flex; flex-direction: column; justify-content: center; height: 100%;
        }
        .input-field {
            width: 100%; padding: 15px; border-radius: 14px;
            border: 1px solid #e5e7eb; background: #fff; 
            font-size: 1rem; margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .btn-primary {
            width: 100%; padding: 15px; background: var(--primary); color: white;
            border: none; border-radius: 14px; font-weight: 600; font-size: 1rem;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); cursor: pointer;
        }
        .link-text { color: var(--primary); font-weight: 600; cursor: pointer; }

        /* --- APP HEADER --- */
        .header {
            padding: calc(15px + var(--safe-top)) 20px 15px;
            background: var(--card);
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            display: flex; justify-content: space-between; align-items: center;
            z-index: 10; position: relative;
        }
        .user-pill { display: flex; align-items: center; gap: 10px; }
        .user-pill img { width: 45px; height: 45px; border-radius: 50%; }
        .bal-badge { background: #e0e7ff; color: var(--primary); padding: 8px 15px; border-radius: 20px; font-weight: 700; font-size: 1rem; }

        /* --- WALLET CARD --- */
        .wallet-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            margin: 20px; padding: 25px; border-radius: 24px;
            color: white; box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4);
            position: relative; overflow: hidden;
        }
        .wallet-balance { font-size: 2.2rem; font-weight: 700; margin: 5px 0 15px; }
        .wallet-actions { display: flex; gap: 15px; }
        .btn-action {
            flex: 1; padding: 12px; border-radius: 14px; border: none;
            font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            font-size: 1rem;
        }
        .btn-action i { font-size: 1.3rem; }
        .btn-dep { background: white; color: var(--primary); }
        .btn-wit { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); }

        /* --- GAME CARD (16:9 UPDATE) --- */
        .game-card {
            background: var(--card); margin: 0 20px 20px;
            border-radius: 20px; overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: flex; flex-direction: column;
        }
        .game-img { 
            width: 100%; 
            height: auto; 
            aspect-ratio: 16/9; /* 16:9 Aspect Ratio */
            object-fit: cover; 
            background: #ddd; 
        }
        .game-body { padding: 15px; }
        .game-title { font-weight: 700; font-size: 1.1rem; margin-bottom: 5px; }
        .game-meta { display: flex; justify-content: space-between; font-size: 0.9rem; color: #6b7280; margin-bottom: 10px; }
        .progress-track { height: 8px; background: #f3f4f6; border-radius: 4px; overflow: hidden; margin-bottom: 8px; }
        .progress-fill { height: 100%; background: var(--green); transition: width 0.3s ease; }
        .game-stats { display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 600; margin-bottom: 15px; color: #374151; }
        .btn-join {
            width: 100%; padding: 12px; border: none; background: var(--primary);
            color: white; border-radius: 12px; font-weight: 600; cursor: pointer;
            font-size: 1rem;
        }
        .btn-join:disabled { background: #d1d5db; cursor: not-allowed; }

        /* --- MY MATCH CARD --- */
        .match-card {
            background: var(--card); margin: 0 20px 15px; padding: 15px;
            border-radius: 16px; border-left: 5px solid var(--primary);
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            cursor: pointer;
        }

        /* --- MATCH DETAILS SCREEN --- */
        .detail-header {
            padding: calc(15px + var(--safe-top)) 20px 15px;
            background: var(--primary); color: white;
            display: flex; align-items: center; gap: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .back-btn { font-size: 1.5rem; cursor: pointer; }

        .room-section {
            margin: 20px; background: white; padding: 20px;
            border-radius: 16px; text-align: center;
            border: 2px dashed #cbd5e1;
        }
        .slot-info-box {
            background: #f0f9ff; padding: 15px; border-radius: 12px;
            border: 1px solid #bae6fd; margin: 0 20px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .participant-list {
            background: white; border-top-left-radius: 24px; border-top-right-radius: 24px;
            padding: 20px; min-height: 300px;
        }
        .participant-row {
            display: flex; justify-content: space-between; padding: 12px 0;
            border-bottom: 1px solid #f1f5f9; align-items: center;
        }
        .slot-badge {
            width: 35px; height: 35px; background: #e0e7ff; color: var(--primary);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 0.9rem; margin-right: 12px;
        }

        /* --- TRANSACTIONS --- */
        .trans-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; border-bottom: 1px solid #f3f4f6; background: var(--card);
        }
        .t-plus { color: var(--green); } .t-minus { color: var(--red); }

        /* --- BOTTOM NAV --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: calc(75px + var(--safe-bottom));
            background: white; display: flex; justify-content: space-around;
            padding-top: 10px; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); z-index: 100;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: #9ca3af; font-size: 0.75rem; gap: 6px; background: none; border: none;
        }
        .nav-item i { font-size: 1.8rem; transition: transform 0.2s; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: translateY(-3px); }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000;
            display: none; align-items: center; justify-content: center;
            padding: 20px; backdrop-filter: blur(4px);
        }
        .modal-box {
            background: white; width: 100%; max-width: 340px;
            border-radius: 24px; padding: 25px;
            animation: bounceIn 0.4s; position: relative;
        }
        @keyframes bounceIn { 
            0% { transform: scale(0.8); opacity: 0; } 
            60% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; color: #999; }

    </style>
</head>
<body>

    <!-- ================= MODAL CONTAINER ================= -->
    <div id="modal-overlay" class="modal-overlay"></div>

    <!-- ================= SPLASH SCREEN ================= -->
    <div id="screen-splash" class="screen center active">
        <i class="fas fa-gamepad fa-4x" style="color: var(--primary); margin-bottom: 20px;"></i>
        <h2 style="color: var(--text); font-size: 1.5rem;">WarX Arena</h2>
        <p style="color: #9ca3af; margin-top: 10px;">Loading...</p>
    </div>

    <!-- ================= AUTH SCREEN ================= -->
    <div id="screen-auth" class="screen center">
        <div class="auth-box">
            <h1 style="color: var(--primary); margin-bottom: 5px;">WarX Arena</h1>
            <p style="color: #6b7280; margin-bottom: 30px;">Login to Continue</p>
            
            <div id="form-login">
                <input type="email" id="l-email" class="input-field" placeholder="Email Address">
                <input type="password" id="l-pass" class="input-field" placeholder="Password">
                <button onclick="doLogin()" class="btn-primary">Sign In</button>
                <p style="margin-top:20px; text-align:center; font-size:0.9rem;">
                    New User? <span class="link-text" onclick="toggleAuth('register')">Create Account</span>
                </p>
            </div>

            <div id="form-register" class="hidden">
                <input type="text" id="r-name" class="input-field" placeholder="Username">
                <input type="email" id="r-email" class="input-field" placeholder="Email Address">
                <input type="password" id="r-pass" class="input-field" placeholder="Create Password">
                <button onclick="doRegister()" class="btn-primary">Create Account</button>
                <p style="margin-top:20px; text-align:center; font-size:0.9rem;">
                    Already have an account? <span class="link-text" onclick="toggleAuth('login')">Login</span>
                </p>
            </div>
        </div>
    </div>

    <!-- ================= MAIN APP ================= -->
    <div id="screen-app" class="screen">
        
        <!-- 1. HOME TAB (Tournaments) -->
        <div id="tab-home" class="w-full h-full scroll-y">
            <div class="header">
                <div class="user-pill">
                    <img id="head-avatar" src="">
                    <div class="flex flex-col">
                        <span style="font-size:0.75rem; color:#6b7280;">Welcome Back,</span>
                        <span id="head-name" style="font-weight:700; font-size:1rem;">Player</span>
                    </div>
                </div>
                <div class="bal-badge">₹<span class="live-bal">0</span></div>
            </div>

            <div style="padding: 20px 20px 10px;">
                <h3 style="font-weight:700; font-size:1.3rem;">Live Tournaments</h3>
            </div>
            
            <div id="list-games">
                <!-- Games Injected Here -->
            </div>
        </div>

        <!-- 2. MY MATCHES TAB -->
        <div id="tab-matches" class="w-full h-full hidden scroll-y">
            <div class="header"><h2>My Matches</h2></div>
            <div id="list-my-matches" style="padding-top:15px;"></div>
        </div>

        <!-- 3. WALLET TAB -->
        <div id="tab-wallet" class="w-full h-full hidden scroll-y">
            <div class="header"><h2>My Wallet</h2></div>
            
            <div class="wallet-card">
                <div style="font-size:1rem; opacity:0.9;">Available Balance</div>
                <div class="wallet-balance">₹<span class="live-bal">0</span></div>
                <div class="wallet-actions">
                    <button class="btn-action btn-dep" onclick="modalDeposit()">
                        <i class="fas fa-plus-circle"></i> Add Cash
                    </button>
                    <button class="btn-action btn-wit" onclick="modalWithdraw()">
                        <i class="fas fa-arrow-down"></i> Withdraw
                    </button>
                </div>
            </div>

            <h3 style="padding: 10px 20px; font-size:1.1rem;">History</h3>
            <div id="list-trans"></div>
        </div>

        <!-- 4. PROFILE TAB -->
        <div id="tab-profile" class="w-full h-full hidden scroll-y">
            <div class="header"><h2>Profile</h2></div>
            <div class="center flex-col" style="padding: 30px 20px;">
                <img id="profile-avatar" src="" style="width:110px; height:110px; border-radius:50%; box-shadow:0 5px 15px rgba(0,0,0,0.1);">
                <h2 id="profile-name-big" style="margin-top:15px; font-size:1.5rem;">Player</h2>
                <p id="profile-email" style="color:#6b7280; font-size:0.9rem;">user@example.com</p>
                
                <div style="width:100%; margin-top:30px;">
                    <button onclick="modalEditProfile()" class="btn-primary" style="background:white; color:#333; margin-bottom:12px;">Edit Profile</button>
                    <button onclick="modalSupport()" class="btn-primary" style="background:var(--secondary); margin-bottom:12px;">Help & Support</button>
                    <button onclick="firebase.auth().signOut()" class="btn-primary" style="background:#fee2e2; color:var(--red);">Log Out</button>
                </div>
            </div>
        </div>

        <!-- BOTTOM NAVIGATION -->
        <div class="bottom-nav">
            <button class="nav-item active" onclick="nav('home')"><i class="fas fa-gamepad"></i><span>Play</span></button>
            <button class="nav-item" onclick="nav('matches')"><i class="fas fa-trophy"></i><span>Matches</span></button>
            <button class="nav-item" onclick="nav('wallet')"><i class="fas fa-wallet"></i><span>Wallet</span></button>
            <button class="nav-item" onclick="nav('profile')"><i class="fas fa-user"></i><span>Profile</span></button>
        </div>
    </div>

    <!-- ================= MATCH DETAILS SCREEN ================= -->
    <div id="screen-match-details" class="screen">
        <div class="detail-header">
            <i class="fas fa-arrow-left back-btn" onclick="closeMatchDetails()"></i>
            <h3 id="det-title" style="margin-left:10px;">Match Details</h3>
        </div>

        <div class="w-full h-full scroll-y">
            
            <!-- Room ID Area -->
            <div class="room-section">
                <div style="text-transform:uppercase; font-size:0.85rem; color:#64748b; letter-spacing:1px; margin-bottom:10px;">Room Details</div>
                <div id="det-room-container">
                    <!-- Dynamic Content -->
                </div>
            </div>

            <!-- My Slot Info -->
            <div class="slot-info-box">
                <span style="color:#0369a1; font-weight:600;">My Assigned Slot</span>
                <span id="det-my-slot" style="font-size:1.4rem; font-weight:700; color:#0284c7;">-</span>
            </div>

            <!-- Participants -->
            <div class="participant-list">
                <h4 style="margin-bottom:15px; color:#334155;">Joined Players</h4>
                <div id="det-player-list">
                    <!-- Dynamic List -->
                </div>
            </div>
        </div>
    </div>

    <!-- ================= LOGIC ================= -->
    <script>
        // CONFIG
        const firebaseConfig = {
  apiKey: "AIzaSyBQpa_UbsAGK7yJ7tbLapG1ksrHgrbyG2A",
  authDomain: "warx-arena.firebaseapp.com",
  projectId: "warx-arena",
  storageBucket: "warx-arena.firebasestorage.app",
  messagingSenderId: "19518568236",
  appId: "1:19518568236:web:1e316949e5acd9b1ab5e89"
};

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        let currentUser = null;
        let userData = null;
        let currentMatchListener = null;

        // AUTH & SPLASH LOGIC
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                db.collection('users').doc(user.uid).onSnapshot(doc => {
                    if (doc.exists) {
                        userData = doc.data();
                        if(userData.blocked) {
                            auth.signOut();
                            alert("Account Blocked");
                            showScreen('screen-auth');
                            return;
                        }
                        updateUI();
                        showScreen('screen-app'); // Skip login screen
                        initListeners();
                    }
                });
            } else {
                showScreen('screen-auth');
            }
        });

        function toggleAuth(mode) {
            document.getElementById('form-login').classList.add('hidden');
            document.getElementById('form-register').classList.add('hidden');
            document.getElementById('form-' + mode).classList.remove('hidden');
        }

        function doLogin() {
            const e = document.getElementById('l-email').value;
            const p = document.getElementById('l-pass').value;
            if(!e || !p) return alert("Fill all fields");
            auth.signInWithEmailAndPassword(e, p).catch(err => alert(err.message));
        }

        function doRegister() {
            const n = document.getElementById('r-name').value;
            const e = document.getElementById('r-email').value;
            const p = document.getElementById('r-pass').value;
            if(!n || !e || !p) return alert("Fill all fields");

            auth.createUserWithEmailAndPassword(e, p).then(cred => {
                return db.collection('users').doc(cred.user.uid).set({
                    username: n, email: e, balance: 0, uid: cred.user.uid,
                    blocked: false, createdAt: new Date()
                });
            }).catch(err => alert(err.message));
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function updateUI() {
            const name = userData.username;
            const img = `https://ui-avatars.com/api/?name=${name}&background=4f46e5&color=fff`;
            
            document.getElementById('head-avatar').src = img;
            document.getElementById('profile-avatar').src = img;
            document.getElementById('head-name').innerText = name;
            document.getElementById('profile-name-big').innerText = name;
            document.getElementById('profile-email').innerText = userData.email;
            
            document.querySelectorAll('.live-bal').forEach(e => e.innerText = userData.balance);
        }

        function nav(tab) {
            document.querySelectorAll('#screen-app > .w-full').forEach(e => e.classList.add('hidden'));
            document.getElementById('tab-' + tab).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            event.currentTarget.classList.add('active');

            if(tab === 'matches') fetchMyMatches();
            if(tab === 'wallet') fetchTransactions();
        }

        // --- REALTIME LISTENERS ---
        function initListeners() {
            db.collection('tournaments').orderBy('time', 'desc').onSnapshot(snap => {
                const list = document.getElementById('list-games');
                list.innerHTML = '';
                snap.forEach(doc => {
                    const t = doc.data();
                    const percent = Math.min((t.filled / t.total) * 100, 100);
                    const isFull = t.filled >= t.total;

                    list.innerHTML += `
                        <div class="game-card">
                            <img src="${t.image || 'https://via.placeholder.com/400x200'}" class="game-img">
                            <div class="game-body">
                                <div class="game-title">${t.title}</div>
                                <div class="game-meta">
                                    <span><i class="far fa-clock"></i> ${t.time}</span>
                                    <span style="color:var(--primary); font-weight:700;">Entry: ₹${t.fee}</span>
                                </div>
                                <div class="progress-track">
                                    <div class="progress-fill" style="width:${percent}%; background:${isFull ? 'var(--red)' : 'var(--green)'}"></div>
                                </div>
                                <div class="game-stats">
                                    <span>Pool: ₹${t.pool}</span>
                                    <span>${t.filled}/${t.total} Joined</span>
                                </div>
                                <button onclick="joinGame('${doc.id}', ${t.fee})" class="btn-join" ${isFull ? 'disabled' : ''}>
                                    ${isFull ? 'FULL' : 'JOIN MATCH'}
                                </button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        // --- JOIN & SLOT LOGIC ---
        async function joinGame(tid, fee) {
            if(userData.balance < fee) return showModal('<h3>Low Balance</h3><p>Please add money to wallet.</p>');

            const check = await db.collection('users').doc(currentUser.uid).collection('my_matches').doc(tid).get();
            if(check.exists) return showModal('<h3>Already Joined</h3><p>You are already in this match.</p>');

            // Ask for Game Name (IGN)
            showModal(`
                <h3>Join Tournament</h3>
                <p style="margin-bottom:10px;">Entry Fee: ₹${fee}</p>
                <input id="join-ign" class="input-field" placeholder="Enter Game Name (e.g. PUBG ID)">
                <button onclick="processJoin('${tid}', ${fee})" class="btn-primary">Pay & Join</button>
            `);
        }

        function processJoin(tid, fee) {
            const ign = document.getElementById('join-ign').value;
            if(!ign) return alert("Please enter your Game Name");
            closeModal();

            const tRef = db.collection('tournaments').doc(tid);
            const uRef = db.collection('users').doc(currentUser.uid);

            db.runTransaction(async (t) => {
                const gameDoc = await t.get(tRef);
                const userDoc = await t.get(uRef);
                const gData = gameDoc.data();

                if(gData.filled >= gData.total) throw "Match Full";
                if(userDoc.data().balance < fee) throw "Low Balance";

                // Calculate Slot
                const newSlot = gData.filled + 1;

                // Deduct & Increment
                t.update(uRef, { balance: firebase.firestore.FieldValue.increment(-fee) });
                t.update(tRef, { filled: firebase.firestore.FieldValue.increment(1) });
                
                // Add to My Matches
                t.set(uRef.collection('my_matches').doc(tid), {
                    matchId: tid, title: gData.title, 
                    time: gData.time, joinedAt: new Date()
                });

                // Add to Match Participants (With Slot & IGN)
                t.set(tRef.collection('participants').doc(currentUser.uid), {
                    userId: currentUser.uid,
                    username: userData.username,
                    ign: ign,
                    slot: newSlot,
                    joinedAt: new Date()
                });

                // Log Transaction
                const transRef = uRef.collection('transactions').doc();
                t.set(transRef, {
                    type: 'Match Fee', amount: fee, isDebit: true, date: new Date()
                });

            }).then(() => showModal('<h3>Success!</h3><p>Joined Successfully. Slot Assigned.</p>'))
              .catch(e => showModal(`<h3>Error</h3><p>${e}</p>`));
        }

        // --- MATCH DETAILS & MY MATCHES ---
        function fetchMyMatches() {
            const list = document.getElementById('list-my-matches');
            list.innerHTML = '<div class="center" style="padding:20px;">Loading...</div>';
            
            db.collection('users').doc(currentUser.uid).collection('my_matches')
            .orderBy('joinedAt', 'desc').onSnapshot(snap => {
                list.innerHTML = '';
                if(snap.empty) { list.innerHTML = '<p class="center" style="color:#999; margin-top:30px;">No matches joined.</p>'; return; }

                snap.forEach(doc => {
                    const m = doc.data();
                    list.innerHTML += `
                        <div class="match-card" onclick="viewMatchDetails('${m.matchId}')">
                            <div style="font-weight:700; font-size:1.1rem;">${m.title}</div>
                            <div style="font-size:0.85rem; color:#6b7280; margin-top:5px;">${m.time}</div>
                            <div style="margin-top:10px; font-weight:600; font-size:0.8rem; color:var(--primary);">
                                Tap to view Room ID & Slots <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    `;
                });
            });
        }

        function viewMatchDetails(tid) {
            showScreen('screen-match-details');
            
            // 1. Get Room Details
            db.collection('tournaments').doc(tid).onSnapshot(doc => {
                if(!doc.exists) return;
                const t = doc.data();
                document.getElementById('det-title').innerText = t.title;

                const roomCont = document.getElementById('det-room-container');
                if(t.roomId && t.password) {
                    roomCont.innerHTML = `
                        <div style="font-size:1.1rem; margin-bottom:5px;">
                            ID: <strong>${t.roomId}</strong> <i class="far fa-copy" onclick="copy('${t.roomId}')" style="color:var(--primary); cursor:pointer;"></i>
                        </div>
                        <div style="font-size:1.1rem;">
                            PASS: <strong>${t.password}</strong> <i class="far fa-copy" onclick="copy('${t.password}')" style="color:var(--primary); cursor:pointer;"></i>
                        </div>
                    `;
                } else {
                    roomCont.innerHTML = `<div style="color:#f59e0b; font-weight:600;"><i class="fas fa-clock"></i> Room details will be updated here.</div>`;
                }
            });

            // 2. Get My Slot
            db.collection('tournaments').doc(tid).collection('participants').doc(currentUser.uid).get().then(doc => {
                if(doc.exists) {
                    document.getElementById('det-my-slot').innerText = "#" + doc.data().slot;
                }
            });

            // 3. Get All Participants List
            if(currentMatchListener) currentMatchListener(); // Unsubscribe prev
            const pList = document.getElementById('det-player-list');
            pList.innerHTML = 'Loading players...';

            currentMatchListener = db.collection('tournaments').doc(tid).collection('participants')
            .orderBy('slot', 'asc').onSnapshot(snap => {
                pList.innerHTML = '';
                snap.forEach(pDoc => {
                    const p = pDoc.data();
                    pList.innerHTML += `
                        <div class="participant-row">
                            <div class="flex center">
                                <div class="slot-badge">${p.slot}</div>
                                <div>
                                    <div style="font-weight:600; font-size:0.9rem;">${p.ign}</div>
                                    <div style="font-size:0.75rem; color:#64748b;">@${p.username}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            });
        }

        function closeMatchDetails() {
            showScreen('screen-app');
            if(currentMatchListener) currentMatchListener();
        }

        // --- WALLET LOGIC (Restored) ---
        function modalDeposit() {
            db.collection('settings').doc('payment').get().then(doc => {
                const d = doc.data() || {};
                showModal(`
                    <h3>Deposit Money</h3>
                    ${d.qrCodeUrl ? `<img src="${d.qrCodeUrl}" style="width:150px; display:block; margin:10px auto;">` : ''}
                    <p style="text-align:center; font-size:0.9rem; margin-bottom:10px;">UPI: <strong>${d.adminUpi || 'Not Available'}</strong></p>
                    <input id="dep-amt" type="number" class="input-field" placeholder="Amount (₹)">
                    <input id="dep-utr" type="text" class="input-field" placeholder="Enter UTR / Transaction ID">
                    <button onclick="reqDeposit()" class="btn-primary">Submit Request</button>
                `);
            });
        }

        function reqDeposit() {
            const amt = Number(document.getElementById('dep-amt').value);
            const utr = document.getElementById('dep-utr').value;
            if(!amt || !utr) return;
            
            db.collection('wallet_requests').add({
                userId: currentUser.uid, username: userData.username,
                type: 'deposit', amount: amt, utr: utr, status: 'pending', timestamp: new Date()
            }).then(() => { closeModal(); showModal('<h3>Sent!</h3><p>Admin will verify shortly.</p>'); });
        }

        function modalWithdraw() {
            showModal(`
                <h3>Withdraw</h3>
                <p style="color:var(--red); font-size:0.8rem; margin-bottom:10px;">Minimum: ₹100</p>
                <input id="wit-amt" type="number" class="input-field" placeholder="Amount">
                <select id="wit-type" class="input-field" style="background:white;">
                    <option value="UPI">UPI Transfer</option>
                    <option value="Redeem Code">Redeem Code</option>
                </select>
                <input id="wit-detail" class="input-field" placeholder="UPI ID or Email/Number">
                <button onclick="reqWithdraw()" class="btn-primary">Request</button>
            `);
        }

        function reqWithdraw() {
            const amt = Number(document.getElementById('wit-amt').value);
            const method = document.getElementById('wit-type').value;
            const det = document.getElementById('wit-detail').value;

            if(amt < 100) return alert("Min ₹100");
            if(userData.balance < amt) return alert("Low Balance");

            const uRef = db.collection('users').doc(currentUser.uid);
            db.runTransaction(async (t) => {
                const u = await t.get(uRef);
                if(u.data().balance < amt) throw "Error";
                
                t.update(uRef, { balance: firebase.firestore.FieldValue.increment(-amt) });
                
                const reqRef = db.collection('wallet_requests').doc();
                t.set(reqRef, {
                    userId: currentUser.uid, username: userData.username,
                    type: 'withdraw', amount: amt, userUpi: `${method}: ${det}`,
                    status: 'pending', timestamp: new Date()
                });
                
                const transRef = uRef.collection('transactions').doc();
                t.set(transRef, {
                    type: 'Withdraw Request', amount: amt, isDebit: true, date: new Date()
                });

            }).then(() => { closeModal(); showModal('<h3>Requested</h3><p>Amount deducted. Processing...</p>'); });
        }

        function fetchTransactions() {
            const list = document.getElementById('list-trans');
            db.collection('users').doc(currentUser.uid).collection('transactions')
            .orderBy('date', 'desc').limit(20).onSnapshot(snap => {
                list.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    list.innerHTML += `
                        <div class="trans-item">
                            <div>
                                <div style="font-weight:600; font-size:0.9rem;">${d.type}</div>
                                <div style="font-size:0.75rem; color:#9ca3af;">${d.date ? d.date.toDate().toLocaleDateString() : ''}</div>
                            </div>
                            <div class="${d.isDebit ? 't-minus' : 't-plus'}" style="font-weight:700;">
                                ${d.isDebit ? '-' : '+'}₹${d.amount}
                            </div>
                        </div>
                    `;
                });
            });
        }

        // --- PROFILE UTILS (Restored) ---
        function modalEditProfile() {
            showModal(`
                <h3>Edit Username</h3>
                <input id="new-u-name" class="input-field" value="${userData.username}">
                <button onclick="saveProfile()" class="btn-primary">Update</button>
            `);
        }
        function saveProfile() {
            const n = document.getElementById('new-u-name').value;
            if(n) db.collection('users').doc(currentUser.uid).update({username: n}).then(() => closeModal());
        }

        function modalSupport() {
            showModal(`
                <h3>Help & Support</h3>
                <textarea id="sup-msg" class="input-field" rows="4" placeholder="Describe your issue..."></textarea>
                <button onclick="sendSupport()" class="btn-primary">Send Ticket</button>
            `);
        }
        function sendSupport() {
            const msg = document.getElementById('sup-msg').value;
            if(msg) {
                db.collection('support_tickets').add({
                    uid: currentUser.uid, email: userData.email, issue: msg, status: 'open', date: new Date()
                }).then(() => { closeModal(); alert("Ticket Sent Successfully"); });
            }
        }

        // GENERAL UTILS
        function showModal(html) {
            const el = document.getElementById('modal-overlay');
            el.innerHTML = `<div class="modal-box"><div class="close-btn" onclick="closeModal()">&times;</div>${html}</div>`;
            el.style.display = 'flex';
        }
        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
        function copy(txt) { navigator.clipboard.writeText(txt); alert("Copied: "+txt); }

    </script>
</body>
</html>